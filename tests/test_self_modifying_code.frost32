.org 0x0000
main:
{
	// Assume top of available memory is here
	cpya sp, 0x7fff

	cpya u0, 9
	cpya u1, 8

	; Try some self-modifying code
	addsi lr, pc, 8
	bra modify_subroutine

	; Branch to subroutine
	addsi lr, pc, 8
	bra to_modify


done:
	bra quit

}

.org 0x2000
to_modify:
{
	;add u7, u0, u1
	add zero, zero, zero
	jmp lr
}

modify_subroutine:
{
	subi sp, 8
	stri u0, [sp, 4]
	stri u1, [sp, 8]

	cpyi u0, data_for_modify_subroutine
	ldr u0, [u0, zero]

	cpyi u1, to_modify
	str u0, [u1, zero]

	ldri u0, [sp, 4]
	ldri u1, [sp, 8]
	addi sp, 8
	jmp lr
}

data_for_modify_subroutine:
{
	;add u7, u0, u1
	mul u7, u0, u1
}

.org 0x4000
quit:
{
	bra quit
}

.org 0x6000
data_0:
	.space 20
